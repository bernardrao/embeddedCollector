{let e,t,r,o,n,l,s,f,i,h,w,a,d,u,_,c,S,g,y,b,m,v,j,x,O,V;s=Object.getPrototypeOf,i={},h=s(f={isConnected:1}),w=s(s),a=(e,t,r,o)=>(e??(setTimeout(r,o),new Set)).add(t),d=(e,t,o)=>{let n=r;r=t;try{return e(o)}catch(e){return console.error(e),o}finally{r=n}},u=e=>e.filter(e=>e.t?.isConnected),_=e=>n=a(n,e,()=>{for(let e of n)e.o=u(e.o),e.l=u(e.l);n=l},1e3),c={get val(){return r?.i?.add(this),this.rawVal},get oldVal(){return r?.i?.add(this),this.h},set val(o){r?.u?.add(this),o!==this.rawVal&&(this.rawVal=o,this.o.length+this.l.length?(t?.add(this),e=a(e,this,O)):this.h=o)}},S=e=>({__proto__:c,rawVal:e,h:e,o:[],l:[]}),g=(e,t)=>{let r={i:new Set,u:new Set},n={f:e},l=o;o=[];let s=d(e,r,t);s=(s??document).nodeType?s:new Text(s);for(let e of r.i)r.u.has(e)||(_(e),e.o.push(n));for(let e of o)e.t=s;return o=l,n.t=s},y=(e,t=S(),r)=>{let n={i:new Set,u:new Set},l={f:e,s:t};l.t=r??o?.push(l)??f,t.val=d(e,n,t.rawVal);for(let e of n.i)n.u.has(e)||(_(e),e.l.push(l));return t},b=(e,...t)=>{for(let r of t.flat(1/0)){let t=s(r??0),o=t===c?g(()=>r.val):t===w?g(r):r;o!=l&&e.append(o)}return e},m=(e,t,...r)=>{let[o,...n]=s(r[0]??0)===h?r:[{},...r],f=e?document.createElementNS(e,t):document.createElement(t);for(let[e,r]of Object.entries(o)){let o=t=>t?Object.getOwnPropertyDescriptor(t,e)??o(s(t)):l,n=t+","+e,h=i[n]??(i[n]=o(s(f))?.set??0),a=e.startsWith("on")?(t,r)=>{let o=e.slice(2);f.removeEventListener(o,r),f.addEventListener(o,t)}:h?h.bind(f):f.setAttribute.bind(f,e),d=s(r??0);e.startsWith("on")||d===w&&(r=y(r),d=c),d===c?g(()=>(a(r.val,r.h),f)):a(r)}return b(f,...n)},v=e=>({get:(t,r)=>m.bind(l,e,r)}),j=new Proxy(e=>new Proxy(m,v(e)),v()),x=(e,t)=>t?t!==e&&e.replaceWith(t):e.remove(),O=()=>{let r=0,o=[...e].filter(e=>e.rawVal!==e.h);do{t=new Set;for(let e of new Set(o.flatMap(e=>e.l=u(e.l))))y(e.f,e.s,e.t),e.t=l}while(++r<100&&(o=[...t]).length);let n=[...e].filter(e=>e.rawVal!==e.h);e=l;for(let e of new Set(n.flatMap(e=>e.o=u(e.o))))x(e.t,g(e.f,e.t)),e.t=l;for(let e of n)e.h=e.rawVal},V={add:b,tags:j,state:S,derive:y,hydrate:(e,t)=>x(e,g(t,e))},window.van=V}{let e,t,r,{fromEntries:o,entries:l,keys:n,hasOwn:f,getPrototypeOf:i}=Object,{get:a,set:y,deleteProperty:c,ownKeys:s}=Reflect,{state:m,derive:d,add:u}=van,b=1e3,w=Symbol(),A=Symbol(),S=Symbol(),_=Symbol(),g=Symbol(),p=Symbol(),P=e=>(e[A]=1,e),h=e=>e instanceof Object&&!(e instanceof Function)&&!e[p],v=e=>{if(e?.[A]){let t=m();return d(()=>{let r=e();h(t.rawVal)&&h(r)?T(t.rawVal,r):t.val=O(r)}),t}return m(O(e))},F=e=>{let t=Array.isArray(e)?[]:{__proto__:i(e)};for(let[r,o]of l(e))t[r]=v(o);return t[S]=[],t[_]=m(1),t},O=e=>!h(e)||e[w]?e:new Proxy(F(e),{get:(e,t,r)=>t===w?e:f(e,t)?Array.isArray(e)&&"length"===t?(e[_].val,e.length):e[t].val:a(e,t,r),set:(e,o,l,n)=>f(e,o)?Array.isArray(e)&&"length"===o?(l!==e.length&&++e[_].val,e.length=l,1):(e[o].val=O(l),1):o in e?y(e,o,l,n):y(e,o,v(l))&&(++e[_].val,K(e).forEach(N.bind(t,n,o,e[o],r)),1),deleteProperty:(e,t)=>(c(e,t)&&k(e,t),++e[_].val),ownKeys:e=>(e[_].val,s(e))}),D=e=>(e[p]=1,e),j=e=>e[w],x=e=>e[w]?new Proxy(e[w],{get:(e,t)=>x(e[t].rawVal)}):e,K=e=>e[S]=e[S].filter(e=>e.t.isConnected),N=(e,t,r,o,{t:l,f})=>{let i=Array.isArray(e),a=i?Number(t):t;u(l,()=>l[g][t]=f(r,()=>delete e[t],a)),i&&!o&&a!==e.length-1&&l.insertBefore(l.lastChild,l[g][n(e).find(e=>Number(e)>a)])},k=(e,t)=>{for(let r of K(e)){let e=r.t[g];e[t]?.remove(),delete e[t]}},C=r=>(e??(setTimeout(()=>(e.forEach(K),e=t),b),e=new Set)).add(r),E=(e,t,r)=>{let o={t:e instanceof Function?e():e,f:r},n=t[w];o.t[g]={},n[S].push(o),C(n);for(let[e,r]of l(n))N(t,e,r,1,o);return o.t},R=(e,t)=>{for(let[r,o]of l(t)){let t=e[r];h(t)&&h(o)?R(t,o):e[r]=o}for(let r in e)f(t,r)||delete e[r];let r=n(t),o=Array.isArray(e);if(o||n(e).some((e,t)=>e!==r[t])){let l=e[w];if(o)e.length=t.length;else{++l[_].val;let e={...l};for(let e of r)delete l[e];for(let t of r)l[t]=e[t]}for(let{t:e}of K(l)){let{firstChild:t,[g]:o}=e;for(let l of r)t===o[l]?t=t.nextSibling:e.insertBefore(o[l],t)}}return e},T=(e,n)=>{r=1;try{return R(e,n instanceof Function?Array.isArray(e)?n(e.filter(e=>1)):o(n(l(e))):n)}finally{r=t}},q=e=>Array.isArray(e)?e.filter(e=>1).map(q):h(e)?o(l(e).map(([e,t])=>[e,q(t)])):e;window.vanX={calc:P,reactive:O,noreactive:D,stateFields:j,raw:x,list:E,replace:T,compact:q}}const{button,div,span,table,th,tr,td,label,input,select,option}=van.tags;const DEBUG=location.search.includes("debug=1");const ACTION_DICT=[{value:1,label:"充电"},{value:2,label:"放电"},{value:0,label:"静置"}];const ALERT_MAP={commAlert:"通讯状态告警",pcsAlert:"PCS告警",rackAlert:"簇告警",cellAlert:"单体告警",airAlert:"空调告警"};const data=vanX.reactive({pcs:{positiveResistance:0,negativeResistance:0,u:0,i:0,p:0},fire:{alertStatus:0},rack:{u:0,i:0,soc:0,soh:0,capacity:0,canCharge:0,canDischarge:0,sumCharge:0,sumDischarge:0,relay:0,runMode:0},pack:[{sumU:0,maxU:0,minU:0,maxT:0,minT:0},{sumU:0,maxU:0,minU:0,maxT:0,minT:0},{sumU:0,maxU:0,minU:0,maxT:0,minT:0},{sumU:0,maxU:0,minU:0,maxT:0,minT:0},{sumU:0,maxU:0,minU:0,maxT:0,minT:0},{sumU:0,maxU:0,minU:0,maxT:0,minT:0},{sumU:0,maxU:0,minU:0,maxT:0,minT:0},{sumU:0,maxU:0,minU:0,maxT:0,minT:0},{sumU:0,maxU:0,minU:0,maxT:0,minT:0},{sumU:0,maxU:0,minU:0,maxT:0,minT:0}],alert:{commAlert:[],pcsAlert:[],rackAlert:[],cellAlert:[],airAlert:[]}});data.packRanking=vanX.calc(()=>{if(!data.pack){return[]}let maxU=0;data.pack.forEach(item=>{if(maxU<item.sumU){maxU=item.sumU}});const list=data.pack.map((item,index)=>({id:index+1,u:item.sumU,maxU:maxU}));list.sort((a,b)=>b.u-a.u);return list});const settingVisible=van.state(false);const changeRunModeVisible=van.state(false);let settingData={enabled:false,actions:[]};const settingFormData=vanX.reactive(cloneData(settingData));const password=van.state("");const datetime=van.state("");const loading=van.state(false);const paramRunMode=van.state(0);const paramPower=van.state(0);const messageText=van.state("");const messageType=van.state("");let timeoutId;setInterval(()=>{const now=new Date;const YYYY=now.getFullYear();const MM=padZero(now.getMonth()+1);const DD=padZero(now.getDate());const HH=padZero(now.getHours());const mm=padZero(now.getMinutes());const ss=padZero(now.getSeconds());datetime.val=`${YYYY}年${MM}月${DD}日 ${HH}:${mm}:${ss}`},20);setInterval(()=>{requestData({silent:true})},1e3);setInterval(()=>{requestSettingData({silent:true})},1e4);requestData();requestSettingData();async function requestData(option){const res=await request("list",{},option);if(res.code===200){vanX.replace(data,res.data)}}async function requestSettingData(option){const res=await request("getaAutoConfig",{},option);if(res.code===200){settingData=res.data}}async function requestSaveSetting(){const data=vanX.compact(settingFormData);const res=await request("updateAutoConfig",{...data,password:password.val});if(res.code===200){showSuccessMessage("保存设置成功！");settingData=data;settingVisible.val=false;password.val=""}}async function requestSaveRunMode(){const res=await request("controlCharge",{action:paramRunMode.val,p:paramPower.val,password:password.val});if(res.code===200){showSuccessMessage("切换模式成功！");vanX.replace(data,{rack:{runMode:paramRunMode.val}});changeRunModeVisible.val=false;password.val=""}}function showSuccessMessage(text){showMessage("success",text)}function showErrorMessage(text){showMessage("error",text)}function showMessage(type,text){if(timeoutId){clearTimeout(timeoutId);timeoutId=undefined}messageText.val=text;messageType.val=type;timeoutId=setTimeout(()=>{messageText.val="";messageType.val="";timeoutId=undefined},3e3)}const App=()=>{return[Header(),div({class:"app-header-diver"}),Body(),SettingDialog(),ChangeRunModeDialog(),div({class:()=>`message ${messageType.val} ${messageText.val?"":"hide"}`},messageText),div({class:()=>`loading ${loading.val?"":"hide"}`})]};const Header=()=>{return div({class:"app-header center"},div({class:"logo"}),div({class:"menus"},div({class:"menu"},"运行监控")),div({class:"title center"},"工商储EMS监控系统"),div({class:"date-time"},datetime),button({class:"setting-button primary",onclick:showSetting},"设置"))};const showSetting=()=>{vanX.replace(settingFormData,cloneData(settingData));settingVisible.val=true};const Body=()=>{return div({class:"app-body"},div({class:"app-body-left"},BaseInfo(),PackRanking(),Topology()),div({class:"app-body-right"},Alarms()))};const BaseInfo=()=>{return div({class:"base-info"},ModuleTitle("簇基本信息"),div({class:"base-info-content"},BaseInfoGroup1(),BaseInfoGroup2()))};const BaseInfoGroup1=()=>{return div({class:"base-info-group1 flex-row"},BaseInfoGroup1Item("SOC",()=>data.rack?.soc," %"),BaseInfoGroup1Item("SOH",()=>data.rack?.soh," %"),BaseInfoGroup1Item("电量",()=>data.rack?.capacity," kWh"),BaseInfoGroup1Item("绝缘电阻",()=>`${data.pcs?.positiveResistance}/${data.pcs?.positiveResistance}`," kΩ"))};const BaseInfoGroup1Item=(name,value,unit)=>{return div({class:"base-info-group1-item"},span(`${name}：`),span(value),span(unit))};const BaseInfoGroup2=()=>{return div({class:"base-info-group2 flex-row"},BaseInfoGroup2Item("可充电电量",()=>data.rack?.canCharge," kWh"),BaseInfoGroup2Item("可放电电量",()=>data.rack?.canDischarge," kWh"),BaseInfoGroup2Item("累计充电电量",()=>data.rack?.sumCharge," kWh"),BaseInfoGroup2Item("累计放电电量",()=>data.rack?.sumDischarge," kWh"))};const BaseInfoGroup2Item=(name,value,unit)=>{return div({class:"base-info-group2-item"},div(name),div(value,unit))};const PackRanking=()=>{return div({class:"pack-ranking"},ModuleTitle("簇平衡度"),vanX.list(table,data.packRanking,PackRankingItem))};const PackRankingItem=({val:item})=>{return tr(td("pack",item.id),td(Progress((item.maxU===0?100:item.u/item.maxU*100).toFixed(1))),td(item.u," V"))};const Topology=()=>{return div({class:"topology"},ModuleTitle("系统拓扑图"),TopologyRunMode(),div({class:"topology-graph"},div({class:"topology-ac"},"400V"),div({class:"topology-ac-relay"}),div({class:"topology-pcs"}),div({class:"topology-ems"},"EMS"),div({class:"topology-bms"},"BMS"),div({class:"topology-ac-to-pcs-line"}),div({class:"topology-ems-to-bms-line"}),div({class:"topology-ems-to-pcs-line"}),div({class:"topology-bms-to-battery-line"}),div({class:()=>`topology-pcs-to-rack-line ${data.rack?.relay===1?"open":"close"}`}),div({class:()=>`topology-rack-relay ${data.rack?.relay===1?"open":"close"}`}),TopologyPcsInfo(),TopologyRackInfo(),data.pack&&vanX.list(div({class:"topology-packs flex-row"}),data.pack,({val:v},_,i)=>TopologyPack(v,i))))};const TopologyRunMode=()=>{return div({class:"topology-run-mode"},div({class:"topology-run-mode-title"},"运行模式："),TopologyRunModeButton(1,"充电"),TopologyRunModeButton(2,"放电"),TopologyRunModeButton(0,"静置"),TopologyRunModeButton(4,"停机"),TopologyRunModeButton(3,"故障"))};const TopologyRunModeButton=(modeId,modeName)=>{return button({class:()=>data.rack?.runMode===modeId?"primary":"",onclick:()=>{if([0,1,2].includes(modeId)){paramRunMode.val=modeId;paramPower.val=0;changeRunModeVisible.val=true}}},modeName)};const TopologyPcsInfo=()=>{return div({class:"topology-pcs-info"},div(()=>data.pcs?.u," V"),div(()=>data.pcs?.i," A"),div(()=>data.pcs?.p," kW"))};const TopologyRackInfo=()=>{return div({class:"topology-rack-info"},div(()=>data.rack?.u," V"),div(()=>data.rack?.i," A"),div(()=>(data.rack?.u*data.rack?.i/1e3).toFixed(0)," kW"))};const TopologyPack=(item,index)=>{return div({class:"topology-pack"},div({class:"topology-pack-line"}),div({class:"topology-pack-cell-image"},div({class:"topology-pack-cell-image-head"}),div({class:"topology-pack-cell-image-body"},div(span(item.maxU),span(" V")),div(span(item.minU),span(" V")),div(span(item.maxT),span(" ℃")),div(span(item.minT),span(" ℃")))),div({class:"topology-pack-name"},"Pack",index+1))};const Alarms=()=>{return div({class:"alarms"},ModuleTitle("告警信息"),FireAlarmStatus(),vanX.list(div,data.alert,Alarm))};const FireAlarmStatus=()=>{return div({class:"fire-alarm-status"},"火灾探测器·",span({class:()=>data.fire?.alertStatus===4?"error":data.fire?.alertStatus===3?"warning":""},()=>data.fire?.alertStatus===4?"告警":data.fire?.alertStatus===3?"告警":"正常"))};const Alarm=(p,_,i)=>{const{val:item}=p;const names=item.map(n=>div(n));return div({class:"alarm"},div({class:"alarm-title"},ALERT_MAP[i]),div({class:"alarm-content flex-row"},names))};const ChangeRunModeDialog=()=>{const content=div({class:"change-run-mode"},div("切换到【",()=>ACTION_DICT.find(item=>item.value===paramRunMode.val)?.label,"模式】需要密码验证，请输入正确的密码。"),div({class:"change-run-mode-form"},label({class:()=>paramRunMode.val===0?"hide":""},"功率：",input({type:"number",value:paramPower,oninput:e=>paramPower.val=e.target.value})),label("密码：",input({type:"password",value:password,oninput:e=>password.val=e.target.value}))));return Dialog({visible:changeRunModeVisible,title:"更换运行模式",content:content,width:500,height:300,okText:"下发配置",onOk:requestSaveRunMode,onCancel:()=>{password.val="";changeRunModeVisible.val=false}})};const SettingDialog=()=>{const content=div({class:"setting-panel"},ModuleTitle("自动充放电开关"),div({class:"control-auto-switch"},label(input({type:"checkbox",checked:()=>settingFormData.enabled?"checked":"",onchange:()=>settingFormData.enabled=!settingFormData.enabled}),"开启")),ModuleTitle("自动充放电配置"),div({class:"control-auto-run"},settingFormData.actions&&vanX.list(div({class:"control-auto-run-items"}),settingFormData.actions,ControlAutoConfigItem),div({class:"buttons"},button({class:"add-button small",onclick:()=>settingFormData.actions.push({})},"添加配置项"))),ModuleTitle("安全校验"),div({class:"control-auto-auth"},label("密码：",input({type:"password",value:password,oninput:e=>password.val=e.target.value}))));return Dialog({visible:settingVisible,title:"设置",content:content,width:800,height:600,okText:"下发配置",onOk:requestSaveSetting,onCancel:()=>{password.val="";settingVisible.val=false}})};const ControlAutoConfigItem=({val:item},deleter)=>{return div({class:"control-auto-run-item"},label("开始时间：",input({type:"number",value:item.startHour,oninput:e=>item.startHour=+e.target.value})),label("结束时间：",input({type:"number",value:item.endHour,oninput:e=>item.endHour=+e.target.value})),label("动作：",select({oninput:e=>item.action=+e.target.value},ACTION_DICT.map(({value,label})=>option({value:value,selected:()=>item.action===value},label)))),label("功率：",input({type:"number",value:item.p,oninput:e=>item.p=+e.target.value})),button({class:"remove-button small ghost",onclick:deleter},"删除"))};const ModuleTitle=name=>{return div({class:"module-title"},div({class:"module-title-prefix"}),div({class:"module-title-content"},name))};const Progress=value=>{return div({class:"progress"},div({class:"progress-bar",style:()=>`width:${value}%`}),div({class:"progress-text"},value,"%"))};const Dialog=props=>{const{visible,title,content,width=800,height=500,okText="保存",cancelText="取消",onCancel=()=>1,onOk=()=>1}=props;return div({class:"dialog",style:()=>`display:${visible.val?"flex":"none"};`},div({class:"dialog-mask"}),div({class:"dialog-content",style:`width: ${width}px; height: ${height}px;`},div({class:"dialog-content-header"},div({class:"dialog-content-header-title"},title),div({class:"close-button",onclick:onCancel})),div({class:"dialog-content-body"},content),div({class:"dialog-content-footer"},button({onclick:onCancel},cancelText),button({class:"primary",onclick:onOk},okText))))};function cloneData(data){return JSON.parse(JSON.stringify(data))}function padZero(n){return`00${n}`.slice(-2)}function request(action,param,option={}){return new Promise(resolve=>{if(!option.silent){loading.val=true}const data={type:action,param:param};if(DEBUG&&action==="controlCharge"&&Math.random()<.3){action=""}const url=DEBUG?`rjs_${action}.json`:"rjs";fetch(url,{method:"post",body:JSON.stringify(data)}).then(res=>res.json()).then(res=>{if(res.code!==200){showErrorMessage(res.msg)}console.log("req:%o\nres:%o",cloneData(data),cloneData(res));resolve(res)}).catch(e=>{const msg=e.message||"网络错误";showErrorMessage(msg);console.log("req:%o\nres:%$o",cloneData(data),e);resolve({code:500,message:msg})}).finally(()=>{if(!option.silent){loading.val=false}})})}van.add(document.getElementById("app"),App());(()=>{const dom=document.getElementById("app");if(!dom){return}const resize=()=>{const{width,height}=dom.getBoundingClientRect();const{innerWidth:pageWidth,innerHeight:pageHeight}=window;const zoom=Math.min(pageWidth/width,pageHeight/height);console.log("page zoom:",zoom);dom.style.zoom=zoom};window.addEventListener("resize",resize);resize()})();